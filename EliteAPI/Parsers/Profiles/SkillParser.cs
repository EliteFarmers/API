using EliteAPI.Models.Entities.Hypixel;
using EliteAPI.Models.Entities.Timescale;
using EliteFarmers.HypixelAPI.DTOs;

namespace EliteAPI.Parsers.Profiles;

public static class SkillParser
{
	public static void ParseSkills(this ProfileMember member, ProfileMemberResponse memberData) {
		var skills = member.Skills;
		var incoming = memberData.PlayerData?.Experience;

		if (incoming is null) {
			member.Api.Skills = false;
			return;
		}

		member.Api.Skills = incoming.SkillCombat is not null && incoming.SkillMining is not null;

		skills.Combat = incoming.SkillCombat ?? skills.Combat;
		skills.Mining = incoming.SkillMining ?? skills.Mining;
		skills.Foraging = incoming.SkillForaging ?? skills.Foraging;
		skills.Fishing = incoming.SkillFishing ?? skills.Fishing;
		skills.Enchanting = incoming.SkillEnchanting ?? skills.Enchanting;
		skills.Alchemy = incoming.SkillAlchemy ?? skills.Alchemy;
		skills.Taming = incoming.SkillTaming ?? skills.Taming;
		skills.Carpentry = incoming.SkillCarpentry ?? skills.Carpentry;
		skills.Runecrafting = incoming.SkillRunecrafting ?? skills.Runecrafting;
		skills.Social = incoming.SkillSocial ?? skills.Social;
		skills.Farming = incoming.SkillFarming ?? skills.Farming;
		skills.Hunting = incoming.SkillHunting ?? skills.Hunting;

		if (memberData.Jacob?.Perks?.FarmingLevelCap is not null && memberData.Jacob.Perks.FarmingLevelCap != 0) {
			skills.LevelCaps ??= new Dictionary<string, int>();
			skills.LevelCaps[SkillName.Farming] = memberData.Jacob.Perks.FarmingLevelCap.Value;
		}

		if (memberData.PetsData?.PetCare?.PetTypesSacrificed.Count is not null &&
		    memberData.PetsData.PetCare.PetTypesSacrificed.Count != 0) {
			skills.LevelCaps ??= new Dictionary<string, int>();
			skills.LevelCaps[SkillName.Taming] = memberData.PetsData.PetCare.PetTypesSacrificed.Count;
		}
	}

	public static Dictionary<string, double> ExtractSkills(this SkillExperience skills) {
		return new Dictionary<string, double> {
			{ SkillName.Combat, skills.Combat },
			{ SkillName.Mining, skills.Mining },
			{ SkillName.Foraging, skills.Foraging },
			{ SkillName.Fishing, skills.Fishing },
			{ SkillName.Enchanting, skills.Enchanting },
			{ SkillName.Alchemy, skills.Alchemy },
			{ SkillName.Taming, skills.Taming },
			{ SkillName.Carpentry, skills.Carpentry },
			{ SkillName.Runecrafting, skills.Runecrafting },
			{ SkillName.Social, skills.Social },
			{ SkillName.Farming, skills.Farming },
			{ SkillName.Hunting, skills.Hunting },
		};
	}

	public static double GetSkillXp(this Skills skills, string skillName) {
		return skillName switch {
			SkillName.Farming => skills.Farming,
			SkillName.Mining => skills.Mining,
			SkillName.Combat => skills.Combat,
			SkillName.Foraging => skills.Foraging,
			SkillName.Fishing => skills.Fishing,
			SkillName.Enchanting => skills.Enchanting,
			SkillName.Alchemy => skills.Alchemy,
			SkillName.Taming => skills.Taming,
			SkillName.Carpentry => skills.Carpentry,
			SkillName.Runecrafting => skills.Runecrafting,
			SkillName.Social => skills.Social,
			SkillName.Hunting => skills.Hunting,
			_ => 0
		};
	}

	public static double GetStandardSkillsXp(this Skills skills) {
		return skills.Farming +
		       skills.Mining +
		       skills.Combat +
		       skills.Foraging +
		       skills.Fishing +
		       skills.Enchanting +
		       skills.Alchemy +
		       skills.Taming +
		       skills.Carpentry +
		       skills.Hunting;
	}

	public static int GetSkillCap(this Skills skills, string skillName) {
		var defaultCap = SkillName.DefaultSkillCaps.GetValueOrDefault(skillName, 50);
		return skills.LevelCaps.TryGetValue(skillName, out var cap) ? defaultCap + cap : defaultCap;
	}

	public static int GetSkillLevel(this Skills skills, string skillName) {
		var maxLevel = skills.GetSkillCap(skillName);
		return GetSkillLevel(skills.GetSkillXp(skillName), skillName, maxLevel);
	}

	public static double GetAverageSkillLevel(this Skills skills) {
		var totalLevel = 0.0;
		var skillCount = 0;

		foreach (var skillName in SkillName.StandardSkills) {
			var level = skills.GetSkillLevel(skillName);
			totalLevel += level;
			skillCount++;
		}

		return skillCount == 0 ? 0 : totalLevel / skillCount;
	}

	public static int GetSkillLevel(double skillXp, string skillName, int cap = -1) {
		var chart = SkillName.SkillLevelChart.GetValueOrDefault(skillName, SkillName.LevelXp);
		var maxLevel = cap == -1 ? SkillName.DefaultSkillCaps.GetValueOrDefault(skillName, 50) : cap;

		return GetSkillLevel(chart, skillXp, maxLevel);
	}

	public static int GetSkillLevel(int[] chart, double skillXp, int maxLevel, bool overflow = false) {
		var xp = skillXp;
		var level = 0;
		foreach (var xpRequirement in chart) {
			if (xp >= xpRequirement && level < maxLevel) {
				level++;
				xp -= xpRequirement;
			}
			else {
				break;
			}
		}
		
		if (overflow && level >= maxLevel) {
			level += (int)(xp / chart[^1]);
		}

		return level;
	}

	public static int GetNetworkLevel(this PlayerData playerData) {
		return GetSkillLevel(NetworkLevel.NetworkLevelXp, playerData.NetworkExp, NetworkLevel.NetworkLevelXp.Length);
	}

	public static int GetNetworkLevel(double networkXp) {
		return GetSkillLevel(NetworkLevel.NetworkLevelXp, networkXp, NetworkLevel.NetworkLevelXp.Length);
	}

	public static int GetDungeoneeringLevel(double dungeonXp) {
		return GetSkillLevel(SkillName.DungeoneeringXp, dungeonXp, 50, true);
	}
}

public static class SkillName
{
	public const string Combat = "combat";
	public const string Mining = "mining";
	public const string Foraging = "foraging";
	public const string Fishing = "fishing";
	public const string Enchanting = "enchanting";
	public const string Alchemy = "alchemy";
	public const string Carpentry = "carpentry";
	public const string Runecrafting = "runecrafting";
	public const string Taming = "taming";
	public const string Farming = "farming";
	public const string Social = "social";
	public const string Hunting = "hunting";

	public static readonly string[] AllSkills = [
		Combat, Mining, Foraging, Fishing,
		Enchanting, Alchemy, Carpentry,
		Runecrafting, Taming, Farming, Social,
		Hunting
	];

	public static readonly string[] StandardSkills = [
		Combat, Mining, Foraging,
		Fishing, Enchanting, Alchemy,
		Carpentry, Taming, Farming,
		Hunting
	];

	public static readonly Dictionary<string, int> DefaultSkillCaps = new() {
		{ SkillName.Farming, 50 },
		{ SkillName.Mining, 60 },
		{ SkillName.Combat, 60 },
		{ SkillName.Foraging, 50 },
		{ SkillName.Fishing, 50 },
		{ SkillName.Enchanting, 60 },
		{ SkillName.Alchemy, 50 },
		{ SkillName.Taming, 50 },
		{ SkillName.Carpentry, 50 },
		{ SkillName.Runecrafting, 25 },
		{ SkillName.Social, 25 },
		{ SkillName.Hunting, 25 },
	};

	public static readonly int[] LevelXp = [
		50, 125, 200, 300, 500,
		750, 1000, 1500, 2000, 3500,
		5000, 7500, 10000, 15000, 20000,
		30000, 50000, 75000, 100000, 200000,
		300000, 400000, 500000, 600000, 700000,
		800000, 900000, 1000000, 1100000, 1200000,
		1300000, 1400000, 1500000, 1600000, 1700000,
		1800000, 1900000, 2000000, 2100000, 2200000,
		2300000, 2400000, 2500000, 2600000, 2750000,
		2900000, 3100000, 3400000, 3700000, 4000000,
		4300000, 4600000, 4900000, 5200000, 5500000,
		5800000, 6100000, 6400000, 6700000, 7000000,
	];

	public static readonly int[] RuneLevelXp = [
		50, 100, 125, 160, 200,
		250, 315, 400, 500, 625,
		785, 1000, 1250, 1600, 2000,
		2465, 3125, 4000, 5000, 6200,
		7800, 9800, 12200, 15300, 19050,
	];

	public static readonly int[] SocialLevelXp = [
		50, 100, 150, 250, 500, 
		750, 1000, 1250, 1500, 2000,
		2500, 3000, 3750, 4500, 6000,
		8000, 10000, 12500, 15000, 20000, 
		25000, 30000, 35000, 40000, 50000,
	];

	public static readonly int[] DungeoneeringXp = [
		50, 75, 110, 160, 230,
		330, 470, 670, 950, 1340,
		1890, 2665, 3760, 5260, 7380,
		10300, 14400, 20000, 27600, 38000,
		52500, 71500, 97000, 132000, 180000,
		243000, 328000, 445000, 600000, 800000,
		1065000, 1410000, 1900000, 2500000, 3300000,
		4300000, 5600000, 7200000, 9200000, 12000000,
		15000000, 19000000, 24000000, 30000000, 38000000,
		48000000, 60000000, 75000000, 93000000, 116250000,
		200000000 // Overflow level 51
	];

	public static readonly Dictionary<string, int[]> SkillLevelChart = new() {
		{ SkillName.Farming, LevelXp },
		{ SkillName.Mining, LevelXp },
		{ SkillName.Combat, LevelXp },
		{ SkillName.Foraging, LevelXp },
		{ SkillName.Fishing, LevelXp },
		{ SkillName.Enchanting, LevelXp },
		{ SkillName.Alchemy, LevelXp },
		{ SkillName.Taming, LevelXp },
		{ SkillName.Carpentry, LevelXp },
		{ SkillName.Runecrafting, RuneLevelXp },
		{ SkillName.Social, SocialLevelXp },
	};
}

public static class NetworkLevel
{
	public static int[] NetworkLevelXp = [
		0,
		10000,
		12500,
		15000,
		17500,
		20000,
		22500,
		25000,
		27500,
		30000,
		32500,
		35000,
		37500,
		40000,
		42500,
		45000,
		47500,
		50000,
		52500,
		55000,
		57500,
		60000,
		62500,
		65000,
		67500,
		70000,
		72500,
		75000,
		77500,
		80000,
		82500,
		85000,
		87500,
		90000,
		92500,
		95000,
		97500,
		100000,
		102500,
		105000,
		107500,
		110000,
		112500,
		115000,
		117500,
		120000,
		122500,
		125000,
		127500,
		130000,
		132500,
		135000,
		137500,
		140000,
		142500,
		145000,
		147500,
		150000,
		152500,
		155000,
		157500,
		160000,
		162500,
		165000,
		167500,
		170000,
		172500,
		175000,
		177500,
		180000,
		182500,
		185000,
		187500,
		190000,
		192500,
		195000,
		197500,
		200000,
		202500,
		205000,
		207500,
		210000,
		212500,
		215000,
		217500,
		220000,
		222500,
		225000,
		227500,
		230000,
		232500,
		235000,
		237500,
		240000,
		242500,
		245000,
		247500,
		250000,
		252500,
		255000,
		257500,
		260000,
		262500,
		265000,
		267500,
		270000,
		272500,
		275000,
		277500,
		280000,
		282500,
		285000,
		287500,
		290000,
		292500,
		295000,
		297500,
		300000,
		302500,
		305000,
		307500,
		310000,
		312500,
		315000,
		317500,
		320000,
		322500,
		325000,
		327500,
		330000,
		332500,
		335000,
		337500,
		340000,
		342500,
		345000,
		347500,
		350000,
		352500,
		355000,
		357500,
		360000,
		362500,
		365000,
		367500,
		370000,
		372500,
		375000,
		377500,
		380000,
		382500,
		385000,
		387500,
		390000,
		392500,
		395000,
		397500,
		400000,
		402500,
		405000,
		407500,
		410000,
		412500,
		415000,
		417500,
		420000,
		422500,
		425000,
		427500,
		430000,
		432500,
		435000,
		437500,
		440000,
		442500,
		445000,
		447500,
		450000,
		452500,
		455000,
		457500,
		460000,
		462500,
		465000,
		467500,
		470000,
		472500,
		475000,
		477500,
		480000,
		482500,
		485000,
		487500,
		490000,
		492500,
		495000,
		497500,
		500000,
		502500,
		505000,
		507500,
		510000,
		512500,
		515000,
		517500,
		520000,
		522500,
		525000,
		527500,
		530000,
		532500,
		535000,
		537500,
		540000,
		542500,
		545000,
		547500,
		550000,
		552500,
		555000,
		557500,
		560000,
		562500,
		565000,
		567500,
		570000,
		572500,
		575000,
		577500,
		580000,
		582500,
		585000,
		587500,
		590000,
		592500,
		595000,
		597500,
		600000,
		602500,
		605000,
		607500,
		610000,
		612500,
		615000,
		617500,
		620000,
		622500,
		625000,
		627500,
		630000,
		632500,
		635000,
		637500,
		640000,
		642500,
		645000,
		647500,
		650000,
		652500,
		655000,
		657500,
		660000,
		662500,
		665000,
		667500,
		670000,
		672500,
		675000,
		677500,
		680000,
		682500,
		685000,
		687500,
		690000,
		692500,
		695000,
		697500,
		700000,
		702500,
		705000,
		707500,
		710000,
		712500,
		715000,
		717500,
		720000,
		722500,
		725000,
		727500,
		730000,
		732500,
		735000,
		737500,
		740000,
		742500,
		745000,
		747500,
		750000,
		752500,
		755000,
		757500,
		760000,
		762500,
		765000,
		767500,
		770000,
		772500,
		775000,
		777500,
		780000,
		782500,
		785000,
		787500,
		790000,
		792500,
		795000,
		797500,
		800000,
		802500,
		805000,
		807500,
		810000,
		812500,
		815000,
		817500,
		820000,
		822500,
		825000,
		827500,
		830000,
		832500,
		835000,
		837500,
		840000,
		842500,
		845000,
		847500,
		850000,
		852500,
		855000,
		857500,
		860000,
		862500,
		865000,
		867500,
		870000,
		872500,
		875000,
		877500,
		880000,
		882500,
		885000,
		887500,
		890000,
		892500,
		895000,
		897500,
		900000,
		902500,
		905000,
		907500,
		910000,
		912500,
		915000,
		917500,
		920000,
		922500,
		925000,
		927500,
		930000,
		932500,
		935000,
		937500,
		940000,
		942500,
		945000,
		947500,
		950000,
		952500,
		955000,
		957500,
		960000,
		962500,
		965000,
		967500,
		970000,
		972500,
		975000,
		977500,
		980000,
		982500,
		985000,
		987500,
		990000,
		992500,
		995000,
		997500,
		1000000,
		1002500,
		1005000,
		1007500,
		1010000,
		1012500,
		1015000,
		1017500,
		1020000,
		1022500,
		1025000,
		1027500,
		1030000,
		1032500,
		1035000,
		1037500,
		1040000,
		1042500,
		1045000,
		1047500,
		1050000,
		1052500,
		1055000,
		1057500,
		1060000,
		1062500,
		1065000,
		1067500,
		1070000,
		1072500,
		1075000,
		1077500,
		1080000,
		1082500,
		1085000,
		1087500,
		1090000,
		1092500,
		1095000,
		1097500,
		1100000,
		1102500,
		1105000,
		1107500,
		1110000,
		1112500,
		1115000,
		1117500,
		1120000,
		1122500,
		1125000,
		1127500,
		1130000,
		1132500,
		1135000,
		1137500,
		1140000,
		1142500,
		1145000,
		1147500,
		1150000,
		1152500,
		1155000,
		1157500,
		1160000,
		1162500,
		1165000,
		1167500,
		1170000,
		1172500,
		1175000,
		1177500,
		1180000,
		1182500,
		1185000,
		1187500,
		1190000,
		1192500,
		1195000,
		1197500,
		1200000,
		1202500,
		1205000,
		1207500,
		1210000,
		1212500,
		1215000,
		1217500,
		1220000,
		1222500,
		1225000,
		1227500,
		1230000,
		1232500,
		1235000,
		1237500,
		1240000,
		1242500,
		1245000,
		1247500,
		1250000,
		1252500,
		1255000,
		1257500,
		1260000,
		1262500,
		1265000,
		1267500,
		1270000,
		1272500,
		1275000,
		1277500,
		1280000,
		1282500,
		1285000,
		1287500,
		1290000,
		1292500,
		1295000,
		1297500,
		1300000,
		1302500,
		1305000,
		1307500,
		1310000,
		1312500,
		1315000,
		1317500,
		1320000,
		1322500,
		1325000,
		1327500,
		1330000,
		1332500,
		1335000,
		1337500,
		1340000,
		1342500,
		1345000,
		1347500,
		1350000,
		1352500,
		1355000,
		1357500,
		1360000,
		1362500,
		1365000,
		1367500,
		1370000,
		1372500,
		1375000,
		1377500,
		1380000,
		1382500,
		1385000,
		1387500,
		1390000,
		1392500,
		1395000,
		1397500,
		1400000,
		1402500,
		1405000,
		1407500,
		1410000,
		1412500,
		1415000,
		1417500,
		1420000,
		1422500,
		1425000,
		1427500,
		1430000,
		1432500,
		1435000,
		1437500,
		1440000,
		1442500,
		1445000,
		1447500,
		1450000,
		1452500,
		1455000,
		1457500,
		1460000,
		1462500,
		1465000,
		1467500,
		1470000,
		1472500,
		1475000,
		1477500,
		1480000,
		1482500,
		1485000,
		1487500,
		1490000,
		1492500,
		1495000,
		1497500,
		1500000,
		1502500,
		1505000,
		1507500,
		1510000,
		1512500,
		1515000,
		1517500,
		1520000,
		1522500,
		1525000,
		1527500,
		1530000,
		1532500,
		1535000,
		1537500,
		1540000,
		1542500,
		1545000,
		1547500,
		1550000,
		1552500,
		1555000,
		1557500,
		1560000,
		1562500,
		1565000,
		1567500,
		1570000,
		1572500,
		1575000,
		1577500,
		1580000,
		1582500,
		1585000,
		1587500,
		1590000,
		1592500,
		1595000,
		1597500,
		1600000,
		1602500,
		1605000,
		1607500,
		1610000,
		1612500,
		1615000,
		1617500,
		1620000,
		1622500,
		1625000,
		1627500,
		1630000,
		1632500,
		1635000,
		1637500,
		1640000,
		1642500,
		1645000,
		1647500,
		1650000,
		1652500,
		1655000,
		1657500,
		1660000,
		1662500,
		1665000,
		1667500,
		1670000,
		1672500,
		1675000,
		1677500,
		1680000,
		1682500,
		1685000,
		1687500,
		1690000,
		1692500,
		1695000,
		1697500,
		1700000,
		1702500,
		1705000,
		1707500,
		1710000,
		1712500,
		1715000,
		1717500,
		1720000,
		1722500,
		1725000,
		1727500,
		1730000,
		1732500,
		1735000,
		1737500,
		1740000,
		1742500,
		1745000,
		1747500,
		1750000,
		1752500,
		1755000,
		1757500,
		1760000,
		1762500,
		1765000,
		1767500,
		1770000,
		1772500,
		1775000,
		1777500,
		1780000,
		1782500,
		1785000,
		1787500,
		1790000,
		1792500,
		1795000,
		1797500,
		1800000,
		1802500,
		1805000,
		1807500,
		1810000,
		1812500,
		1815000,
		1817500,
		1820000,
		1822500,
		1825000,
		1827500,
		1830000,
		1832500,
		1835000,
		1837500,
		1840000,
		1842500,
		1845000,
		1847500,
		1850000,
		1852500,
		1855000,
		1857500,
		1860000,
		1862500,
		1865000,
		1867500,
		1870000,
		1872500,
		1875000,
		1877500,
		1880000,
		1882500,
		1885000,
		1887500,
		1890000,
		1892500,
		1895000,
		1897500,
		1900000,
		1902500,
		1905000,
		1907500,
		1910000,
		1912500,
		1915000,
		1917500,
		1920000,
		1922500,
		1925000,
		1927500,
		1930000,
		1932500,
		1935000,
		1937500,
		1940000,
		1942500,
		1945000,
		1947500,
		1950000,
		1952500,
		1955000,
		1957500,
		1960000,
		1962500,
		1965000,
		1967500,
		1970000,
		1972500,
		1975000,
		1977500,
		1980000,
		1982500,
		1985000,
		1987500,
		1990000,
		1992500,
		1995000,
		1997500,
		2000000,
		2002500,
		2005000,
		2007500,
		2010000,
		2012500,
		2015000,
		2017500,
		2020000,
		2022500,
		2025000,
		2027500,
		2030000,
		2032500,
		2035000,
		2037500,
		2040000,
		2042500,
		2045000,
		2047500,
		2050000,
		2052500,
		2055000,
		2057500,
		2060000,
		2062500,
		2065000,
		2067500,
		2070000,
		2072500,
		2075000,
		2077500,
		2080000,
		2082500,
		2085000,
		2087500,
		2090000,
		2092500,
		2095000,
		2097500,
		2100000,
		2102500,
		2105000,
		2107500,
		2110000,
		2112500,
		2115000,
		2117500,
		2120000,
		2122500,
		2125000,
		2127500,
		2130000,
		2132500,
		2135000,
		2137500,
		2140000,
		2142500,
		2145000,
		2147500,
		2150000,
		2152500,
		2155000,
		2157500,
		2160000,
		2162500,
		2165000,
		2167500,
		2170000,
		2172500,
		2175000,
		2177500,
		2180000,
		2182500,
		2185000,
		2187500,
		2190000,
		2192500,
		2195000,
		2197500,
		2200000,
		2202500,
		2205000,
		2207500,
		2210000,
		2212500,
		2215000,
		2217500,
		2220000,
		2222500,
		2225000,
		2227500,
		2230000,
		2232500,
		2235000,
		2237500,
		2240000,
		2242500,
		2245000,
		2247500,
		2250000,
		2252500,
		2255000,
		2257500,
		2260000,
		2262500,
		2265000,
		2267500,
		2270000,
		2272500,
		2275000,
		2277500,
		2280000,
		2282500,
		2285000,
		2287500,
		2290000,
		2292500,
		2295000,
		2297500,
		2300000,
		2302500,
		2305000,
		2307500,
		2310000,
		2312500,
		2315000,
		2317500,
		2320000,
		2322500,
		2325000,
		2327500,
		2330000,
		2332500,
		2335000,
		2337500,
		2340000,
		2342500,
		2345000,
		2347500,
		2350000,
		2352500,
		2355000,
		2357500,
		2360000,
		2362500,
		2365000,
		2367500,
		2370000,
		2372500,
		2375000,
		2377500,
		2380000,
		2382500,
		2385000,
		2387500,
		2390000,
		2392500,
		2395000,
		2397500,
		2400000,
		2402500,
		2405000,
		2407500,
		2410000,
		2412500,
		2415000,
		2417500,
		2420000,
		2422500,
		2425000,
		2427500,
		2430000,
		2432500,
		2435000,
		2437500,
		2440000,
		2442500,
		2445000,
		2447500,
		2450000,
		2452500,
		2455000,
		2457500,
		2460000,
		2462500,
		2465000,
		2467500,
		2470000,
		2472500,
		2475000,
		2477500,
		2480000,
		2482500,
		2485000,
		2487500,
		2490000,
		2492500,
		2495000,
		2497500,
		2500000,
		2502500,
		2505000,
	];
}